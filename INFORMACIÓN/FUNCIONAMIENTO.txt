================================================================================
                    STEAM HRG - DOCUMENTACIÓN DE FUNCIONAMIENTO
================================================================================

1. DESCRIPCIÓN GENERAL DEL PROYECTO
================================================================================

Steam HRG es una plataforma de compra y gestión de videojuegos que simula la 
experiencia de Steam. Permite a los usuarios:
- Registrarse e iniciar sesión
- Explorar un catálogo de juegos
- Comprar juegos directamente o agregar al carrito
- Gestionar su biblioteca de juegos
- Dejar reseñas en juegos
- Devolver juegos y recuperar dinero

Administradores pueden:
- Gestionar usuarios (crear, editar, eliminar)
- Gestionar juegos (crear, editar, eliminar)
- Gestionar géneros de juegos
- Subir imágenes de juegos


2. ARQUITECTURA Y FLUJO GENERAL
================================================================================

2.1 ESTRUCTURA DE CARPETAS
├── app/
│   ├── Http/Controllers/     → Controladores (lógica de negocio)
│   ├── Models/               → Modelos de base de datos
│   └── Services/             → Servicios (Steam API, etc)
├── routes/
│   └── web.php               → Definición de rutas
├── resources/views/          → Vistas Blade (HTML)
├── public/
│   ├── css/                  → Estilos CSS
│   ├── js/                   → JavaScript
│   └── imagenes/             → Imágenes de juegos
└── database/
    ├── migrations/           → Migraciones de BD
    └── seeders/              → Datos iniciales


2.2 FLUJO DE AUTENTICACIÓN
================================================================================

REGISTRO:
1. Usuario accede a /registro
2. Completa formulario (usuario, email, contraseña)
3. AuthController valida datos
4. Se crea usuario en BD con:
   - Nombre de usuario único
   - Email único
   - Contraseña hasheada (bcrypt)
   - Rol: "user"
   - Saldo inicial: 100€
5. Redirige a login con mensaje de éxito

LOGIN:
1. Usuario accede a /login
2. Ingresa usuario y contraseña
3. AuthController busca usuario en BD
4. Verifica contraseña con Hash::check()
5. Si es correcto:
   - Inicia sesión (Auth::login())
   - Regenera token de sesión
   - Redirige a biblioteca
6. Si es incorrecto: muestra error

LOGOUT:
1. Usuario hace click en "Cerrar sesión"
2. AuthController ejecuta logout:
   - Auth::logout() - cierra sesión
   - session()->invalidate() - invalida sesión
   - session()->regenerateToken() - nuevo token CSRF
3. Redirige a login con mensaje de confirmación


2.3 FLUJO DE COMPRA DE JUEGOS
================================================================================

COMPRA DIRECTA (desde tienda):
1. Usuario ve juego en tienda
2. Hace click en botón "Comprar"
3. BibliotecaController valida:
   - Usuario autenticado
   - Saldo suficiente
   - Juego no está en biblioteca
4. Si es válido:
   - Resta dinero del saldo
   - Agrega juego a biblioteca
   - Muestra mensaje de éxito
5. Si no es válido: muestra error

COMPRA CON CARRITO:
1. Usuario agrega juegos al carrito
2. CarritoController agrega a tabla carritos
3. Usuario accede a /carrito
4. Ve resumen con total y saldo disponible
5. Hace click en "Comprar todo"
6. CarritoController valida cada juego
7. Si todo es válido:
   - Resta dinero del saldo
   - Agrega juegos a biblioteca
   - Vacía carrito
   - Muestra confirmación
8. Si hay error: muestra qué juego no se pudo comprar


2.4 FLUJO DE RESEÑAS
================================================================================

1. Usuario accede a su biblioteca
2. Hace click en botón "Reseña" de un juego
3. Se abre modal con formulario:
   - Calificación (1-5 estrellas)
   - Recomendación (Sí/No)
   - Comentario (10-1000 caracteres)
4. ResenaController valida datos
5. Si es válido:
   - Crea o actualiza reseña en BD
   - Muestra confirmación
6. Las reseñas aparecen en detalles del juego


2.5 FLUJO DE DEVOLUCIONES
================================================================================

1. Usuario está en biblioteca
2. Hace click en "Devolver" de un juego
3. Pide confirmación
4. BibliotecaController procesa devolución:
   - Suma dinero al saldo (reembolso 100%)
   - Elimina juego de biblioteca
   - Elimina reseñas asociadas
5. Muestra confirmación


2.6 PANEL DE ADMINISTRACIÓN
================================================================================

ACCESO:
- Solo usuarios con rol "admin" pueden acceder
- Middleware 'admin' protege las rutas

FUNCIONALIDADES:

Gestión de Usuarios:
- Ver lista de usuarios
- Crear nuevo usuario
- Editar usuario (nombre, email, saldo, rol)
- Eliminar usuario

Gestión de Juegos:
- Ver lista de juegos
- Crear nuevo juego (título, descripción, precio, género, imagen)
- Editar juego
- Eliminar juego
- Subir imagen (se guarda en public/imagenes/)

Dashboard:
- Estadísticas generales
- Usuarios recientes
- Accesos rápidos a gestión


3. SEGURIDAD DEL PROYECTO
================================================================================

3.1 AUTENTICACIÓN Y AUTORIZACIÓN
================================================================================

✓ PROTECCIÓN DE CONTRASEÑAS:
  - Se usan hashes bcrypt (Hash::make())
  - Nunca se almacenan contraseñas en texto plano
  - Verificación con Hash::check()
  - Función: app/Http/Controllers/AuthController.php líneas 32, 75

✓ SESIONES SEGURAS:
  - Token CSRF regenerado en cada login/logout
  - Sesión invalidada al logout
  - Cookies de sesión con HttpOnly (por defecto en Laravel)
  - Líneas: AuthController.php 34, 87-88

✓ MIDDLEWARE DE AUTENTICACIÓN:
  - Rutas protegidas con 'auth' middleware
  - Solo usuarios autenticados pueden acceder a tienda, biblioteca, carrito
  - Rutas admin protegidas con 'admin' middleware
  - Líneas: routes/web.php 27, 56

✓ REGENERACIÓN DE TOKENS:
  - Token CSRF regenerado en login
  - Token CSRF regenerado en logout
  - Previene ataques CSRF
  - Línea: AuthController.php 34, 88


3.2 VALIDACIÓN DE DATOS
================================================================================

✓ VALIDACIÓN EN SERVIDOR:
  - Todas las entradas se validan en el servidor
  - No se confía en validación del cliente
  - Ejemplos:
    * Login: usuario y contraseña requeridos
    * Registro: usuario único, email válido, contraseña confirmada
    * Compra: saldo suficiente, juego no duplicado
    * Reseña: calificación 1-5, comentario 10-1000 caracteres

✓ VALIDACIÓN DE AUTORIZACIÓN:
  - Se verifica que el usuario sea propietario del recurso
  - No se puede devolver juego de otro usuario
  - No se puede editar reseña de otro usuario
  - Admin solo puede hacer operaciones admin

✓ SANITIZACIÓN:
  - Inputs se escapan automáticamente en Blade
  - Se usa prepared statements (Eloquent ORM)
  - Previene inyección SQL


3.3 PROTECCIÓN CONTRA ATAQUES COMUNES
================================================================================

✓ INYECCIÓN SQL:
  - Se usa Eloquent ORM (no SQL directo)
  - Prepared statements automáticos
  - Ejemplo: Usuario::where('nombre', $request->usuario)->first()
  - Línea: AuthController.php 29

✓ XSS (Cross-Site Scripting):
  - Blade escapa automáticamente con {{ }}
  - Se usa {!! !!} solo cuando es necesario (contenido de confianza)
  - Línea: Todas las vistas Blade

✓ CSRF (Cross-Site Request Forgery):
  - Token CSRF en todos los formularios
  - Middleware VerifyCsrfToken protege POST/PUT/DELETE
  - Token regenerado en login/logout
  - Línea: @csrf en todos los formularios Blade

✓ FUERZA BRUTA:
  - No hay limitación de intentos de login (MEJORABLE)
  - Sesión se invalida al logout
  - Recomendación: Agregar throttle en login

✓ INFORMACIÓN SENSIBLE:
  - Contraseñas hasheadas en BD
  - Saldo no se expone en URLs
  - IDs de usuarios no se exponen innecesariamente
  - Mensajes de error genéricos (no revelan si usuario existe)


3.4 GESTIÓN DE SESIONES
================================================================================

✓ TIMEOUT DE SESIÓN:
  - Sesión se cierra después de 4 minutos de inactividad
  - Advertencia 30 segundos antes del cierre
  - Usuario puede extender sesión haciendo click en botón
  - Archivo: public/js/session-manager.js

✓ REGENERACIÓN DE SESIÓN:
  - Token regenerado en login
  - Token regenerado en logout
  - Previene session fixation attacks

✓ COOKIES SEGURAS:
  - HttpOnly: true (no accesible desde JavaScript)
  - SameSite: Lax (previene CSRF)
  - Secure: true en producción (solo HTTPS)
  - Configuración: config/session.php


3.5 CONTROL DE ACCESO
================================================================================

✓ RUTAS PROTEGIDAS:
  - /tienda → Requiere auth
  - /biblioteca → Requiere auth
  - /carrito → Requiere auth
  - /admin/* → Requiere auth + admin role

✓ MIDDLEWARE:
  - 'auth' → Verifica que usuario esté autenticado
  - 'admin' → Verifica que usuario sea admin
  - Líneas: routes/web.php 27, 56

✓ VERIFICACIÓN DE PROPIEDAD:
  - Usuario solo ve sus propios juegos en biblioteca
  - Usuario solo puede devolver sus propios juegos
  - Usuario solo puede reseñar sus propios juegos
  - Ejemplos: BibliotecaController.php líneas 35-36


3.6 PROTECCIÓN DE DATOS SENSIBLES
================================================================================

✓ VARIABLES DE ENTORNO:
  - Credenciales en .env (no en código)
  - APP_KEY para encriptación
  - DB_PASSWORD no expuesto
  - Archivo: .env (no versionado en git)

✓ ENCRIPTACIÓN:
  - Contraseñas: bcrypt (Hash::make)
  - Datos sensibles: Crypt::encrypt() si es necesario
  - Tokens: Generados aleatoriamente

✓ LOGS:
  - Errores se registran en storage/logs/
  - No se exponen detalles en producción
  - Mensajes de error genéricos al usuario


3.7 VALIDACIÓN DE TRANSACCIONES FINANCIERAS
================================================================================

✓ VALIDACIÓN DE SALDO:
  - Se verifica saldo antes de compra
  - Se verifica saldo suficiente para cada juego
  - Se previene compra si saldo insuficiente
  - Línea: BibliotecaController.php 45

✓ PREVENCIÓN DE DUPLICADOS:
  - Se verifica que usuario no tenga juego
  - Se previene compra duplicada
  - Línea: BibliotecaController.php 44

✓ ATOMICIDAD:
  - Compra se realiza de forma atómica
  - Si falla, se revierte todo
  - Se usa transacciones en BD si es necesario

✓ AUDITORÍA:
  - Se registran compras en BD
  - Se registran devoluciones
  - Se puede rastrear historial de transacciones


3.8 RECOMENDACIONES DE MEJORA
================================================================================

⚠ MEJORABLE - BAJA PRIORIDAD:

1. Rate Limiting en Login:
   - Limitar intentos de login por IP
   - Usar middleware throttle
   - Prevenir fuerza bruta

2. Logs de Auditoría:
   - Registrar acciones de admin
   - Registrar cambios en usuarios
   - Registrar compras/devoluciones

3. Encriptación de Datos:
   - Encriptar email en BD
   - Encriptar información sensible

4. 2FA (Autenticación de Dos Factores):
   - Agregar verificación por email
   - Agregar verificación por SMS

5. HTTPS:
   - Forzar HTTPS en producción
   - Certificado SSL/TLS

6. CORS:
   - Configurar CORS si hay API externa
   - Restringir orígenes permitidos

7. Validación de Imágenes:
   - Validar tipo de archivo
   - Validar tamaño máximo
   - Escanear virus (opcional)

8. Backup:
   - Realizar backups periódicos
   - Guardar en ubicación segura


3.9 ESTADO ACTUAL DE SEGURIDAD
================================================================================

NIVEL DE SEGURIDAD: BUENO (para desarrollo/demo)

✓ IMPLEMENTADO:
  - Autenticación segura con bcrypt
  - CSRF protection
  - XSS prevention
  - SQL injection prevention
  - Session management
  - Autorización por roles
  - Validación de datos
  - Timeout de sesión

⚠ NO IMPLEMENTADO (pero recomendado):
  - Rate limiting en login
  - Logs de auditoría detallados
  - 2FA
  - HTTPS obligatorio
  - Encriptación de datos sensibles


4. FLUJO DE DATOS GENERAL
================================================================================

USUARIO NUEVO:
1. Accede a /registro
2. Completa formulario
3. Datos se envían a POST /registro
4. AuthController valida
5. Se crea en BD
6. Redirige a login

USUARIO EXISTENTE:
1. Accede a /login
2. Ingresa credenciales
3. Datos se envían a POST /login
4. AuthController verifica
5. Se inicia sesión
6. Redirige a biblioteca

EN BIBLIOTECA:
1. BibliotecaController obtiene juegos del usuario
2. Se muestran en grid
3. Usuario puede ver detalles, reseñar, devolver

EN TIENDA:
1. TiendaController obtiene todos los juegos
2. Se pueden filtrar por género
3. Se pueden buscar por nombre
4. Usuario puede comprar o agregar al carrito

EN CARRITO:
1. CarritoController obtiene items del carrito
2. Se muestra resumen con total
3. Usuario puede comprar todo o eliminar items

EN ADMIN:
1. AdminController verifica que sea admin
2. Muestra dashboard con estadísticas
3. Permite CRUD de usuarios y juegos


5. TECNOLOGÍAS UTILIZADAS
================================================================================

Backend:
- Laravel 12 (Framework PHP)
- PHP 8.2+
- MySQL (Base de datos)

Frontend:
- Blade (Motor de plantillas)
- HTML5
- CSS3 (con gradientes y animaciones)
- JavaScript (Vanilla)
- Boxicons (Iconos)

Seguridad:
- bcrypt (Hashing de contraseñas)
- CSRF tokens
- Session management
- Middleware de autenticación

APIs Externas:
- Steam API (Trailers y screenshots)


6. CREDENCIALES DE PRUEBA
================================================================================

Usuario Regular:
- Usuario: usuario1
- Contraseña: usuario1
- Saldo inicial: 100€

Administrador:
- Usuario: admin1
- Contraseña: admin1
- Acceso a panel admin


================================================================================
                              FIN DE DOCUMENTACIÓN
================================================================================
